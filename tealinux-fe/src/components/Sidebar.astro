---
import { getCollection } from 'astro:content';
import tealinuxLogo from '../assets/tealinus_ijo.svg';

const docs = await getCollection('docs');
const pathname = Astro.url.pathname;

// Grouping logic
const groups = docs.reduce((acc, doc) => {
  const category = doc.data.category || 'General';
  if (!acc[category]) {
    acc[category] = [];
  }
  acc[category].push(doc);
  return acc;
}, {} as Record<string, typeof docs>);

// Sorting logic: Sort categories (optional) and items within categories
const sortedCategories = Object.keys(groups).sort();
const sidebarData = sortedCategories.map(category => ({
  title: category,
  items: groups[category].sort((a, b) => (a.data.order || 0) - (b.data.order || 0))
}));

const isActive = (slug: string) => {
  const currentPath = pathname.replace(/\/$/, '');
  const targetPath = `/docs/${slug}`.replace(/\/$/, '');
  return currentPath === targetPath || (slug === 'index' && currentPath === '/docs');
};
---

<!-- Mobile Menu Toggle Button -->
<button 
  id="sidebar-toggle"
  class="sidebar-toggle lg:hidden"
  aria-label="Toggle navigation menu"
>
  <svg id="menu-open-icon" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
  </svg>
  <svg id="menu-close-icon" class="hidden" width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
  </svg>
</button>

<!-- Sidebar Overlay -->
<div id="sidebar-overlay" class="sidebar-overlay hidden lg:hidden"></div>

<!-- Sidebar -->
<aside id="docs-sidebar" class="docs-sidebar">
  <div class="p-6">
    <!-- Logo Section -->
    <div class="mb-6 flex items-center justify-between">
      <a href="/docs" class="block">
        <img src={tealinuxLogo.src} alt="TeaLinuxOS" class="h-10 w-auto" />
      </a>
      <!-- Close button for mobile -->
      <button id="sidebar-close" class="lg:hidden p-2 text-slate-400 hover:text-white transition-colors">
        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Search Section -->
    <div class="mb-6">
      <button 
        onclick="window.openSearchModal && window.openSearchModal()"
        class="w-full px-4 py-2.5 bg-white/5 border border-white/10 rounded-lg text-sm text-slate-400 text-left flex items-center gap-3 hover:border-[#54CD4C] hover:text-[#54CD4C] transition-all"
      >
        <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
        <span>Search docs...</span>
        <kbd class="ml-auto text-xs bg-white/10 px-1.5 py-0.5 rounded hidden sm:inline">/</kbd>
      </button>
    </div>

    <!-- Documentation Navigation -->
    <nav class="space-y-6">
      {sidebarData.map((section) => (
        <div>
          <h3 class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-3">
            {section.title}
          </h3>
          <ul class="space-y-1">
            {section.items.map((item) => (
              <li>
                <a 
                  href={`/docs/${item.id === 'index' ? '' : item.id}`}
                  class={`block px-3 py-2 text-sm rounded-lg transition-all ${
                    isActive(item.id) 
                      ? 'bg-[#54CD4C]/20 text-[#54CD4C] font-semibold' 
                      : 'text-slate-300 hover:text-[#54CD4C] hover:bg-white/5'
                  }`}
                >
                  {item.data.title}
                </a>
              </li>
            ))}
          </ul>
        </div>
      ))}
    </nav>
  </div>
</aside>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.getElementById('docs-sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    const toggleBtn = document.getElementById('sidebar-toggle');
    const closeBtn = document.getElementById('sidebar-close');
    const openIcon = document.getElementById('menu-open-icon');
    const closeIcon = document.getElementById('menu-close-icon');

    function openSidebar() {
      sidebar?.classList.add('open');
      overlay?.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      openIcon?.classList.add('hidden');
      closeIcon?.classList.remove('hidden');
    }

    function closeSidebar() {
      sidebar?.classList.remove('open');
      overlay?.classList.add('hidden');
      document.body.style.overflow = '';
      openIcon?.classList.remove('hidden');
      closeIcon?.classList.add('hidden');
    }

    toggleBtn?.addEventListener('click', () => {
      if (sidebar?.classList.contains('open')) {
        closeSidebar();
      } else {
        openSidebar();
      }
    });

    closeBtn?.addEventListener('click', closeSidebar);
    overlay?.addEventListener('click', closeSidebar);

    // Close sidebar when clicking a link on mobile
    const navLinks = sidebar?.querySelectorAll('nav a');
    navLinks?.forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth < 1024) {
          closeSidebar();
        }
      });
    });

    // Close sidebar on resize to desktop
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 1024) {
        closeSidebar();
      }
    });
  });
</script>

<style>
  /* Sidebar Toggle Button */
  .sidebar-toggle {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 60;
    padding: 0.75rem;
    background: rgba(10, 10, 10, 0.9);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    color: #cbd5e1;
    cursor: pointer;
    transition: all 0.2s;
  }

  .sidebar-toggle:hover {
    background: rgba(30, 41, 59, 0.95);
    border-color: #54CD4C;
    color: #54CD4C;
  }

  /* Sidebar Overlay */
  .sidebar-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    z-index: 45;
  }

  /* Sidebar */
  .docs-sidebar {
    position: fixed;
    left: 0;
    top: 0;
    width: 280px;
    height: 100vh;
    background: #0a0a0a;
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    overflow-y: auto;
    z-index: 50;
    transition: transform 0.3s ease;
  }

  /* Mobile styles */
  @media (max-width: 1023px) {
    .docs-sidebar {
      transform: translateX(-100%);
    }

    .docs-sidebar.open {
      transform: translateX(0);
    }
  }

  /* Desktop styles */
  @media (min-width: 1024px) {
    .sidebar-toggle {
      display: none;
    }

    .docs-sidebar {
      transform: translateX(0);
      width: 256px;
    }
  }

  /* Scrollbar styling */
  .docs-sidebar {
    scrollbar-width: thin;
    scrollbar-color: rgba(84, 205, 76, 0.3) transparent;
  }
  
  .docs-sidebar::-webkit-scrollbar {
    width: 6px;
  }
  
  .docs-sidebar::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .docs-sidebar::-webkit-scrollbar-thumb {
    background: rgba(84, 205, 76, 0.3);
    border-radius: 3px;
  }
</style>
