---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/organisms/Navbar.astro';
import Footer from '../../components/organisms/Footer.astro';
---

<Layout title="Create New Topic - TeaLinuxOS Forum">
	<main class="min-h-screen bg-black text-slate-50 font-sans relative overflow-hidden">
		<!-- Gradient Blobs -->
		<div class="absolute z-0 pointer-events-none blur-[100px] opacity-30 -top-[15%] -left-[10%] w-[600px] h-[600px]"
			style="background: radial-gradient(circle at center, rgba(84, 205, 76, 0.3), transparent); border-radius: 50%;">
		</div>

		<div class="relative z-[1]">
			<Navbar />

			<div class="relative py-8 px-[5%] max-w-[800px] mx-auto">
				<!-- Breadcrumb -->
				<nav class="mb-6 text-sm">
					<a href="/forum" class="text-[#54CD4C] hover:underline">Forum</a>
					<span class="text-slate-500 mx-2">/</span>
					<span class="text-slate-300">New Topic</span>
				</nav>

				<!-- Form -->
				<div class="p-8 rounded-xl border border-white/10 bg-gradient-to-br from-white/5 to-white/0">
					<h1 class="text-3xl font-bold text-white mb-6">Create New Topic</h1>
					
					<form id="new-topic-form" class="space-y-6">
						<div>
							<label for="title" class="block text-sm font-medium text-slate-300 mb-2">Title</label>
							<input 
								type="text" 
								id="title" 
								name="title" 
								class="w-full p-4 bg-black/50 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-[#54CD4C] focus:ring-1 focus:ring-[#54CD4C]"
								placeholder="What's your topic about?"
								required
							/>
						</div>

						<div>
							<label for="category" class="block text-sm font-medium text-slate-300 mb-2">Category</label>
							<select 
								id="category" 
								name="category_id" 
								class="w-full p-4 bg-black/50 border border-white/10 rounded-xl text-white focus:outline-none focus:border-[#54CD4C] focus:ring-1 focus:ring-[#54CD4C]"
								required
							>
								<option value="">Select a category...</option>
							</select>
						</div>

						<div>
							<label for="content" class="block text-sm font-medium text-slate-300 mb-2">Content</label>
							<textarea 
								id="content" 
								name="content" 
								rows="8" 
								class="w-full p-4 bg-black/50 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-[#54CD4C] focus:ring-1 focus:ring-[#54CD4C] resize-none"
								placeholder="Share your thoughts in detail..."
								required
							></textarea>
						</div>

						<div>
							<label for="tags" class="block text-sm font-medium text-slate-300 mb-2">Tags (optional)</label>
							<input 
								type="text" 
								id="tags" 
								name="tags" 
								class="w-full p-4 bg-black/50 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-[#54CD4C] focus:ring-1 focus:ring-[#54CD4C]"
								placeholder="Separate tags with commas (e.g., installation, help, bug)"
							/>
						</div>

						<div class="flex gap-4">
							<button 
								type="submit" 
								class="flex-1 px-6 py-3 bg-[#54CD4C] text-black font-bold rounded-full hover:bg-[#45b83f] transition-all flex items-center justify-center gap-2"
							>
								<span>Create Topic</span>
								<div class="loader hidden w-4 h-4 border-2 border-black/30 border-t-black rounded-full animate-spin"></div>
							</button>
							<a 
								href="/forum" 
								class="px-6 py-3 bg-white/10 text-white font-bold rounded-full hover:bg-white/20 transition-all text-center"
							>
								Cancel
							</a>
						</div>
					</form>

					<div id="form-message" class="mt-4 hidden"></div>
				</div>
			</div>

			<Footer />
		</div>
	</main>
</Layout>

<script>
	import { getCategories, createTopic } from '../../lib/api';
	import { isAuthenticated } from '../../lib/auth';

	// Check authentication
	if (!isAuthenticated()) {
		window.location.href = '/login';
	}

	// Load categories
	async function loadCategories() {
		const select = document.getElementById('category') as HTMLSelectElement;
		if (!select) return;

		try {
			const categories = await getCategories();
			categories.forEach(category => {
				const option = document.createElement('option');
				option.value = category.id;
				option.textContent = category.name;
				select.appendChild(option);
			});
		} catch (error) {
			console.error('Failed to load categories:', error);
		}
	}

	// Handle form submission
	async function handleSubmit(e: Event) {
		e.preventDefault();
		
		const form = e.target as HTMLFormElement;
		const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
		const loader = submitBtn.querySelector('.loader');
		const messageEl = document.getElementById('form-message');
		
		const formData = new FormData(form);
		const title = formData.get('title') as string;
		const category_id = formData.get('category_id') as string;
		const content = formData.get('content') as string;
		const tagsInput = formData.get('tags') as string;
		const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

		// Disable form
		submitBtn.disabled = true;
		loader?.classList.remove('hidden');
		
		try {
			const result = await createTopic({ title, category_id, content, tags });
			
			// Show success message
			if (messageEl) {
				messageEl.textContent = 'Topic created successfully! Redirecting...';
				messageEl.className = 'mt-4 p-3 rounded-lg bg-green-500/20 text-green-400 border border-green-500/30';
			}
			
			// Redirect to the new topic
			setTimeout(() => {
				window.location.href = `/forum/topic/${result.topic.slug}`;
			}, 1500);
		} catch (error) {
			if (messageEl) {
				messageEl.textContent = error instanceof Error ? error.message : 'Failed to create topic';
				messageEl.className = 'mt-4 p-3 rounded-lg bg-red-500/20 text-red-400 border border-red-500/30';
			}
			submitBtn.disabled = false;
			loader?.classList.add('hidden');
		}
	}

	// Initialize
	loadCategories();
	const form = document.getElementById('new-topic-form');
	form?.addEventListener('submit', handleSubmit);
</script>
