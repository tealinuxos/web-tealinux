---
import Layout from '../../../layouts/Layout.astro';
import Navbar from '../../../components/organisms/Navbar.astro';
import Footer from '../../../components/organisms/Footer.astro';

export const prerender = false;

const { slug } = Astro.params;
---

<Layout title="Topic - TeaLinuxOS Forum">
	<main class="min-h-screen bg-black text-slate-50 font-sans relative overflow-hidden">


		<div class="relative z-[1]">
			<Navbar />

			<div class="relative py-8 px-[5%] max-w-[1000px] mx-auto">
				<!-- Breadcrumb -->
				<nav id="breadcrumb" class="mb-6 text-sm">
					<a href="/forum" class="text-[#54CD4C] hover:underline">Forum</a>
					<span class="text-slate-500 mx-2">/</span>
					<span class="text-slate-300">Loading...</span>
				</nav>

				<!-- Topic Header -->
				<div id="topic-header" class="mb-8 p-6 rounded-xl border border-white/10 bg-gradient-to-br from-white/5 to-white/0">
					<div class="animate-pulse">
						<div class="h-8 bg-white/10 rounded w-3/4 mb-4"></div>
						<div class="h-4 bg-white/5 rounded w-1/2"></div>
					</div>
				</div>

				<!-- Posts/Comments -->
				<div id="posts-container" class="space-y-4 mb-8">
					<div class="text-center py-12">
						<div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-[#54CD4C]"></div>
						<p class="mt-4 text-slate-400">Loading discussion...</p>
					</div>
				</div>

				<!-- Comment Form (only for authenticated users) -->
				<div id="comment-form-container"></div>
			</div>

			<Footer />
		</div>
	</main>
</Layout>

<script>
	import { getTopic, getTopicPosts, createPost, likePost, unlikePost } from '../../../lib/api';
	import { isAuthenticated, getCurrentUser } from '../../../lib/auth';

	const slug = window.location.pathname.split('/').pop();
	let currentTopicId = '';

	async function loadTopicAndPosts() {
		const breadcrumb = document.getElementById('breadcrumb');
		const topicHeader = document.getElementById('topic-header');
		const postsContainer = document.getElementById('posts-container');
		const commentFormContainer = document.getElementById('comment-form-container');
		
		if (!topicHeader || !postsContainer) return;

		try {
			// Load topic
			const topic = await getTopic(slug || '');
			currentTopicId = topic.id;
			
			// Update breadcrumb
			if (breadcrumb) {
				breadcrumb.innerHTML = `
					<a href="/forum" class="text-[#54CD4C] hover:underline">Forum</a>
					<span class="text-slate-500 mx-2">/</span>
					<a href="/forum/category/${topic.category.slug}" class="text-[#54CD4C] hover:underline">${topic.category.name}</a>
					<span class="text-slate-500 mx-2">/</span>
					<span class="text-slate-300">${topic.title}</span>
				`;
			}

			// Update topic header
			const tags = topic.tags?.map(tag => `<span class="px-3 py-1 text-xs bg-[#54CD4C]/20 text-[#54CD4C] rounded-full">${tag.name}</span>`).join('') || '';
			topicHeader.innerHTML = `
				<div class="flex items-start justify-between gap-4">
					<div class="flex-1">
						<h1 class="text-3xl font-bold text-white mb-3">${topic.title}</h1>
						<div class="flex items-center gap-3 text-sm text-slate-400 mb-3">
							<span>by <span class="text-[#54CD4C]">${topic.user.name}</span></span>
							<span>•</span>
							<span>${new Date(topic.created_at).toLocaleDateString()}</span>
							<span>•</span>
							<span>${topic.views} views</span>
						</div>
						${tags ? `<div class="flex gap-2">${tags}</div>` : ''}
					</div>
				</div>
			`;

			// Load posts
			const posts = await getTopicPosts(topic.id);
			
			if (posts.length === 0) {
				postsContainer.innerHTML = `
					<div class="text-center py-12 border border-white/10 rounded-xl bg-white/5">
						<p class="text-slate-400">No comments yet. Be the first to comment!</p>
					</div>
				`;
			} else {
				postsContainer.innerHTML = posts.map(post => {
					const likeCount = post.likes?.length || 0;
					const currentUser = getCurrentUser();
					const isLiked = currentUser && post.likes?.some(like => like.user_id === currentUser.id);
					
					return `
						<div class="flex w-full p-6 flex-col gap-4 rounded-xl border border-white/10 bg-gradient-to-br from-white/5 to-white/0 backdrop-blur-sm" data-post-id="${post.id}">
							<div class="flex items-start gap-4">
								<div class="w-10 h-10 rounded-full bg-[#54CD4C]/20 flex items-center justify-center text-[#54CD4C] font-bold">
									${post.user.name.charAt(0).toUpperCase()}
								</div>
								<div class="flex-1">
									<div class="flex items-center gap-2 mb-2">
										<span class="font-bold text-white">${post.user.name}</span>
										<span class="text-xs text-slate-500">${new Date(post.created_at).toLocaleString()}</span>
									</div>
									<div class="text-slate-200 whitespace-pre-wrap">${post.content}</div>
									<div class="flex items-center gap-4 mt-3">
										<button class="like-btn flex items-center gap-2 text-sm ${isLiked ? 'text-[#54CD4C]' : 'text-slate-400'} hover:text-[#54CD4C] transition-colors" data-post-id="${post.id}" data-liked="${isLiked}">
											<svg class="w-5 h-5" fill="${isLiked ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
											</svg>
											<span class="like-count">${likeCount}</span>
										</button>
									</div>
								</div>
							</div>
						</div>
					`;
				}).join('');

				// Add like button event listeners
				document.querySelectorAll('.like-btn').forEach(btn => {
					btn.addEventListener('click', handleLikeClick);
				});
			}

			// Show comment form if authenticated
			if (isAuthenticated() && commentFormContainer) {
				commentFormContainer.innerHTML = `
					<div class="p-6 rounded-xl border border-white/10 bg-gradient-to-br from-white/5 to-white/0">
						<h3 class="text-xl font-bold text-white mb-4">Add a Comment</h3>
						<form id="comment-form">
							<textarea 
								id="comment-content" 
								name="content" 
								rows="4" 
								class="w-full p-4 bg-black/50 border border-white/10 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:border-[#54CD4C] focus:ring-1 focus:ring-[#54CD4C] resize-none"
								placeholder="Share your thoughts..."
								required
							></textarea>
							<div class="flex justify-end mt-4">
								<button type="submit" class="px-6 py-2 bg-[#54CD4C] text-black font-bold rounded-full hover:bg-[#45b83f] transition-all flex items-center gap-2">
									<span>Post Comment</span>
									<div class="loader hidden w-4 h-4 border-2 border-black/30 border-t-black rounded-full animate-spin"></div>
								</button>
							</div>
						</form>
						<div id="comment-message" class="mt-4 hidden"></div>
					</div>
				`;

				// Add form submit handler
				const commentForm = document.getElementById('comment-form');
				commentForm?.addEventListener('submit', handleCommentSubmit);
			} else if (commentFormContainer) {
				commentFormContainer.innerHTML = `
					<div class="p-6 rounded-xl border border-white/10 bg-gradient-to-br from-white/5 to-white/0 text-center">
						<p class="text-slate-400 mb-4">Please log in to join the discussion</p>
						<a href="/login" class="inline-block px-6 py-2 bg-[#54CD4C] text-black font-bold rounded-full hover:bg-[#45b83f] transition-all">
							Log In
						</a>
					</div>
				`;
			}
		} catch (error) {
			if (postsContainer) {
				postsContainer.innerHTML = `
					<div class="text-center py-12 border border-red-500/20 rounded-xl bg-red-500/5">
						<p class="text-red-400">Failed to load topic</p>
						<p class="text-sm text-slate-500 mt-2">${error instanceof Error ? error.message : 'Unknown error'}</p>
					</div>
				`;
			}
		}
	}

	async function handleCommentSubmit(e: Event) {
		e.preventDefault();
		
		const form = e.target as HTMLFormElement;
		const textarea = form.querySelector('textarea') as HTMLTextAreaElement;
		const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
		const loader = submitBtn.querySelector('.loader');
		const messageEl = document.getElementById('comment-message');
		
		const content = textarea.value.trim();
		if (!content) return;

		// Disable form
		submitBtn.disabled = true;
		loader?.classList.remove('hidden');
		
		try {
			await createPost(currentTopicId, content);
			
			// Show success message
			if (messageEl) {
				messageEl.textContent = 'Comment posted successfully!';
				messageEl.className = 'mt-4 p-3 rounded-lg bg-green-500/20 text-green-400 border border-green-500/30';
			}
			
			// Clear form
			textarea.value = '';
			
			// Reload posts
			setTimeout(() => {
				loadTopicAndPosts();
			}, 1000);
		} catch (error) {
			if (messageEl) {
				messageEl.textContent = error instanceof Error ? error.message : 'Failed to post comment';
				messageEl.className = 'mt-4 p-3 rounded-lg bg-red-500/20 text-red-400 border border-red-500/30';
			}
		} finally {
			submitBtn.disabled = false;
			loader?.classList.add('hidden');
		}
	}

	async function handleLikeClick(e: Event) {
		e.preventDefault();
		
		if (!isAuthenticated()) {
			alert('Please log in to like posts');
			return;
		}

		const btn = e.currentTarget as HTMLButtonElement;
		const postId = btn.dataset.postId;
		const isLiked = btn.dataset.liked === 'true';
		
		if (!postId) return;

		try {
			if (isLiked) {
				await unlikePost(postId);
			} else {
				await likePost(postId);
			}
			
			// Reload posts to update like count
			loadTopicAndPosts();
		} catch (error) {
			console.error('Failed to toggle like:', error);
		}
	}

	loadTopicAndPosts();
</script>
