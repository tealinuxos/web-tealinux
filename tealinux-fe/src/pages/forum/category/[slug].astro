---
import Layout from '../../../layouts/Layout.astro';
import Navbar from '../../../components/organisms/Navbar.astro';
import Footer from '../../../components/organisms/Footer.astro';

export const prerender = false;

const { slug } = Astro.params;
---

<Layout title="Category - TeaLinuxOS Forum">
	<main class="min-h-screen bg-black text-slate-50 font-sans relative overflow-hidden">
		<!-- Gradient Blobs -->
		<div class="absolute z-0 pointer-events-none blur-[100px] opacity-50 -top-[15%] -left-[10%] w-[600px] h-[600px]"
			style="background: radial-gradient(circle at center, rgba(84, 205, 76, 0.4), transparent); border-radius: 50%;">
		</div>

		<div class="relative z-[1]">
			<Navbar />

			<div class="relative py-8 px-[5%] max-w-[1200px] mx-auto">
				<!-- Breadcrumb -->
				<nav class="mb-6 text-sm">
					<a href="/forum" class="text-[#54CD4C] hover:underline">Forum</a>
					<span class="text-slate-500 mx-2">/</span>
					<span id="category-name" class="text-slate-300">Loading...</span>
				</nav>

				<!-- Category Header -->
				<div id="category-header" class="mb-8">
					<div class="animate-pulse">
						<div class="h-8 bg-white/10 rounded w-64 mb-2"></div>
						<div class="h-4 bg-white/5 rounded w-96"></div>
					</div>
				</div>

				<!-- New Topic Button -->
				<div class="mb-6 flex justify-between items-center">
					<h2 class="text-2xl font-bold text-white">Topics</h2>
					<a href="/forum/new" id="new-topic-btn" class="hidden px-6 py-2 bg-[#54CD4C] text-black font-bold rounded-full hover:bg-[#45b83f] transition-all">
						+ New Topic
					</a>
				</div>

				<!-- Topics List -->
				<div id="topics-container" class="space-y-4">
					<div class="text-center py-12">
						<div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-[#54CD4C]"></div>
						<p class="mt-4 text-slate-400">Loading topics...</p>
					</div>
				</div>
			</div>

			<Footer />
		</div>
	</main>
</Layout>

<script>
	import { getCategory, getTopics } from '../../../lib/api';
	import { isAuthenticated } from '../../../lib/auth';

	const slug = window.location.pathname.split('/').pop();

	async function loadCategoryAndTopics() {
		const categoryNameEl = document.getElementById('category-name');
		const categoryHeaderEl = document.getElementById('category-header');
		const topicsContainer = document.getElementById('topics-container');
		const newTopicBtn = document.getElementById('new-topic-btn');
		
		if (!categoryNameEl || !categoryHeaderEl || !topicsContainer) return;

		try {
			// Load category info
			const category = await getCategory(slug || '');
			
			categoryNameEl.textContent = category.name;
			categoryHeaderEl.innerHTML = `
				<h1 class="text-4xl font-bold text-[#54CD4C] mb-2">${category.name}</h1>
				<p class="text-slate-300">${category.description || 'No description available'}</p>
			`;

			// Show new topic button if authenticated
			if (isAuthenticated() && newTopicBtn) {
				newTopicBtn.classList.remove('hidden');
			}

			// Load topics
			const topics = await getTopics(category.id);
			
			if (topics.length === 0) {
				topicsContainer.innerHTML = `
					<div class="text-center py-12 border border-white/10 rounded-xl bg-white/5">
						<p class="text-slate-400">No topics yet. Be the first to start a discussion!</p>
					</div>
				`;
				return;
			}

			topicsContainer.innerHTML = topics.map(topic => {
				const postCount = topic.posts?.length || 0;
				const createdDate = new Date(topic.created_at).toLocaleDateString();
				const tags = topic.tags?.map(tag => `<span class="px-2 py-1 text-xs bg-[#54CD4C]/20 text-[#54CD4C] rounded-full">${tag.name}</span>`).join('') || '';
				
				return `
					<a href="/forum/topic/${topic.slug}" class="block">
						<div class="flex w-full p-5 flex-col gap-3 rounded-xl border border-white/10 bg-gradient-to-br from-white/5 to-white/0 backdrop-blur-sm hover:border-[#54CD4C]/30 hover:shadow-[0_0_15px_rgba(84,205,76,0.15)] transition-all duration-200 cursor-pointer">
							<div class="flex items-start justify-between gap-4">
								<div class="flex-1">
									<h3 class="text-lg font-bold text-white mb-1 ${topic.is_pinned ? 'flex items-center gap-2' : ''}">
										${topic.is_pinned ? '<svg class="w-4 h-4 text-[#54CD4C]" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1.323l3.954 1.582 1.599-.8a1 1 0 01.894 1.79l-1.233.616 1.738 5.42a1 1 0 01-.285 1.05A3.989 3.989 0 0115 15a3.989 3.989 0 01-2.667-1.019 1 1 0 01-.285-1.05l1.738-5.42-1.233-.617a1 1 0 01.894-1.788l1.599.799L11 4.323V3a1 1 0 011-1zm-5 8.274l-.818 2.552c-.25.78-.07 1.619.49 2.21A3.989 3.989 0 007 16a3.989 3.989 0 002.328-1.036c.56-.591.74-1.43.49-2.21L9 10.274v-1.61a1 1 0 10-2 0v1.61z"/></svg>' : ''}
										${topic.title}
									</h3>
									<div class="flex items-center gap-3 text-sm text-slate-400">
										<span>by ${topic.user.name}</span>
										<span>•</span>
										<span>${createdDate}</span>
										<span>•</span>
										<span>${topic.views} views</span>
										<span>•</span>
										<span>${postCount} ${postCount === 1 ? 'reply' : 'replies'}</span>
									</div>
									${tags ? `<div class="flex gap-2 mt-2">${tags}</div>` : ''}
								</div>
							</div>
						</div>
					</a>
				`;
			}).join('');
		} catch (error) {
			if (topicsContainer) {
				topicsContainer.innerHTML = `
					<div class="text-center py-12 border border-red-500/20 rounded-xl bg-red-500/5">
						<p class="text-red-400">Failed to load topics</p>
						<p class="text-sm text-slate-500 mt-2">${error instanceof Error ? error.message : 'Unknown error'}</p>
					</div>
				`;
			}
		}
	}

	loadCategoryAndTopics();
</script>
