---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Processing Login - TeaLinux Forum">
	<main>
		<div class="callback-container">
			<div class="loader"></div>
			<h1>Processing Login...</h1>
			<p>Please wait while we set up your session.</p>
		</div>
	</main>
</Layout>

<script>
	import { saveAuthData } from '../../lib/auth';

	// Get query parameters
	const urlParams = new URLSearchParams(window.location.search);
	const access_token = urlParams.get('access_token');
	const refresh_token = urlParams.get('refresh_token');
	const id = urlParams.get('id');
	const name = urlParams.get('name');
	const email = urlParams.get('email');
	const role = urlParams.get('role');
	const avatar = urlParams.get('avatar');

	if (access_token && refresh_token && id && name && email && role) {
		// Save auth data
		saveAuthData(
			{ access_token, refresh_token },
			{
				id: parseInt(id),
				name,
				email,
				role,
				avatar: avatar || ''
			}
		);

		// Redirect based on role
		setTimeout(() => {
			if (role === 'admin') {
				window.location.href = '/admin';
			} else {
				window.location.href = '/';
			}
		}, 1000);
	} else {
		// Handle error
		console.error('Missing authentication data');
		window.location.href = '/login?error=oauth_failed';
	}
</script>

<style>
	main {
		min-height: 100vh;
		display: flex;
		align-items: center;
		justify-content: center;
		background: radial-gradient(circle at top left, #1e293b, #0f172a);
		font-family: 'Inter', system-ui, sans-serif;
		color: #f8fafc;
	}

	.callback-container {
		text-align: center;
	}

	.loader {
		width: 48px;
		height: 48px;
		border: 4px solid rgba(255, 255, 255, 0.1);
		border-radius: 50%;
		border-top-color: #2ecc71;
		animation: spin 1s linear infinite;
		margin: 0 auto 24px;
	}

	h1 {
		font-size: 1.5rem;
		font-weight: 700;
		margin-bottom: 8px;
	}

	p {
		color: #94a3b8;
	}

	@keyframes spin {
		to { transform: rotate(360deg); }
	}
</style>
