---
import AdminLayout from "../../components/templates/AdminLayout.astro"
import UsersTable from "../../components/organisms/UsersTable.astro"

const users = []
---

<AdminLayout>
  <h1 class="text-2xl font-bold mb-6">Users</h1>
  <UsersTable users={users} />
</AdminLayout>

<script is:inline>
  {
    const API_URL = 'http://localhost:3000/api/admin/users';
    const token = localStorage.getItem('tealinux_token');

    if (!token) {
      window.location.href = '/login';
    }

    async function fetchUsers() {
      try {
        const res = await fetch(API_URL, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        if (!res.ok) {
          if (res.status === 401) {
              window.location.href = '/login';
              return;
          }
          throw new Error('Failed to fetch');
        }
        const data = await res.json();
        const userList = Array.isArray(data) ? data : (data.users || []);
        renderUsers(userList);
      } catch (err) {
        console.error(err);
      }
    }

    function renderUsers(users) {
      const tbody = document.getElementById('users-table-body');
      if (!tbody) return;
      
      if (users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="p-3 text-center text-slate-400">No users found</td></tr>';
          return;
      }

      tbody.innerHTML = users.map(u => {
          const isAdmin = u.role === 'admin' || u.role === 'Admin';
          const badgeClass = isAdmin ? "bg-green-500/20 text-green-500" : "bg-white/10 text-slate-400";
          
          return `
          <tr class="hover:bg-slate-800/50 transition-colors">
            <td class="p-3 border-b border-slate-700 text-slate-200">${u.name}</td>
            <td class="p-3 border-b border-slate-700 text-slate-200">${u.email}</td>
            <td class="p-3 border-b border-slate-700">
              <span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">
                ${u.role}
              </span>
            </td>
            <td class="p-3 border-b border-slate-700">
              <button 
                  class="px-3.5 py-1.5 rounded-md text-sm cursor-pointer border-none transition-colors bg-red-500 text-white hover:bg-red-600"
                  onclick="deleteUser(${u.id})"
              >
                Delete
              </button>
            </td>
          </tr>
          `
      }).join('');
    }

    // Make deleteUser global
    window.deleteUser = async (id) => {
        if(!confirm('Are you sure you want to delete this user?')) return;
        
        try {
            const res = await fetch(`http://localhost:3000/api/admin/users/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if(res.ok) {
                fetchUsers(); // Refresh list
            } else {
                const err = await res.json();
                alert(err.message || 'Failed to delete user');
            }
        } catch(e) {
            console.error(e);
            alert('Error deleting user');
        }
    }

    fetchUsers();
  }
</script>
